<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale-1.0">
<title>Pendaftaran Ahli - Chatbot</title>
<style>
/* --- GAYA CSS FINAL (Replika Hampir 100% Flowdeck/WhatsApp) --- */
body {
font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
background-color: #ECE5DD;
margin: 0;
padding: 0;
display: flex;
justify-content: center;
align-items: flex-end;
min-height: 100vh;
}

.chat-container {
width: 100%;
max-width: 600px;
height: 100vh;
background-color: #ffffff;
display: flex;
flex-direction: column;
overflow: hidden;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
position: relative;
}

.chat-header {
background-color: #006400; /* Warna Tema PAS (Hijau Gelap) */
color: white;
padding: 10px 15px;
font-size: 1.1em;
display: flex;
align-items: center;
box-shadow: 0 1px 3px rgba(0,0,0,0.15);
z-index: 10;
}

.chat-header .profile-pic-placeholder {
width: 40px;
height: 40px;
border-radius: 50%;
background-color: #eee;
margin-right: 10px;
display: flex;
align-items: center;
justify-content: center;
}

.chat-header h2 {
margin: 0;
font-size: 1em;
}

.chat-header .status {
font-size: 0.7em;
color: #c8e6c9; /* Warna status diubah suai */
margin-top: 2px;
}

.chat-box {
padding: 10px;
overflow-y: auto;
flex-grow: 1;
background-color: #E6DDD5;
background-image: url('https://raw.githubusercontent.com/kamarul95-cloud/qrcode/refs/heads/main/IMG-20251111-WA0000.jpg');
background-repeat: no-repeat;
background-size: cover;
background-position: center;
background-attachment: scroll;
display: flex;
flex-direction: column;
}

.message {
max-width: 75%;
padding: 6px 9px 8px 9px;
border-radius: 8px;
margin-bottom: 5px;
word-wrap: break-word;
clear: both;
box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
line-height: 1.35;
position: relative;
font-size: 0.95em;
}

.bot-message {
background-color: #ffffff;
margin-right: auto;
margin-left: 2px;
border-top-left-radius: 0;
}

.user-message {
background-color: #DCF8C6;
margin-left: auto;
margin-right: 2px;
border-top-right-radius: 0;
text-align: left;
}

.bot-message img {
max-width: 100%;
height: auto;
border-radius: 5px;
margin-top: 5px;
}
.bot-message a {
    color: #006400;
    font-weight: 600;
    text-decoration: underline;
}

.input-area {
padding: 8px;
background-color: #f0f0f0;
display: flex;
flex-wrap: wrap;
gap: 5px;
border-top: 1px solid #eee;
align-items: flex-end;
}

.typing-bubble {
    background-color: #ffffff; /* Warna bubble bot */
    margin-right: auto;
    margin-left: 2px;
    margin-bottom: 5px;
    border-top-left-radius: 0; /* Ekor */
    border-radius: 8px;
    padding: 9px 12px;
    width: fit-content;
    display: flex;
    align-items: center;
    box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
}

.credit-message {
    background-color: transparent;
    box-shadow: none;
    margin: 15px auto 10px auto;
    text-align: center;
    font-size: 0.8em;
    color: #555;
    font-style: italic;
    border-top: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
    padding: 5px 10px;
    max-width: 80%;
}

.dot {
height: 6px;
width: 6px;
background-color: #555;
border-radius: 50%;
display: inline-block;
margin-left: 2px;
animation: bounce 1.2s infinite ease-in-out;
}

.dot:nth-child(2) { animation-delay: 0.4s; }
.dot:nth-child(3) { animation-delay: 0.8s; }

@keyframes bounce {
0%, 80%, 100% { transform: translateY(0); }
40% { transform: translateY(-5px); }
}

.input-area input[type="text"],
.input-area input[type="date"],
.input-area input[type="email"],
.input-area textarea {
flex-grow: 1;
padding: 10px 15px;
border: none;
border-radius: 20px;
background-color: #ffffff;
min-height: 40px;
box-sizing: border-box;
}
.input-area textarea {
    border-radius: 10px;
    min-height: 60px;
}


.input-area button {
background-color: #006400; /* Warna Tema PAS */
color: white;
border: none;
padding: 10px 15px;
border-radius: 20px;
cursor: pointer;
font-weight: bold;
transition: background-color 0.2s;
font-size: 0.9em;
width: auto;
height: auto;
display: inline-block;
}

.send-button-wa {
width: 48px !important;
height: 48px !important;
border-radius: 50% !important;
display: flex !important;
justify-content: center !important;
align-items: center !important;
padding: 0 !important;
font-size: 1.5em !important;
background-color: #006400 !important; /* Warna Tema PAS */
}

.choice-button {
margin-top: 5px;
flex: 1 1 48%;
background-color: #f7f7f7 !important;
color: #000 !important;
border: 1px solid #ccc !important;
box-shadow: 0 1px 1px rgba(0,0,0,0.05);
padding: 8px 10px;
font-weight: normal;
text-align: left;
border-radius: 10px !important;
}
.choice-button.selected {
    background-color: #e0f0e0 !important;
    border-color: #006400 !important;
    font-weight: bold;
}
.choice-button.red {
    background-color: #fff0f0 !important;
    border-color: #d9534f !important;
    color: #d9534f !important;
}

@media (max-width: 600px) {
.chat-container {
border-radius: 0;
}
}
</style>‚Äã-
</head>
<body>

<div class="chat-container">
<div class="chat-header">
<div class="profile-pic-placeholder">
<span style="font-size: 20px;">üìù</span>
</div>
<div>
<h2>Pendaftaran Ahli</h2>
<p class="status">online</p>
</div>
</div>
<div class="chat-box" id="chat-box">
</div>

<div class="input-area" id="input-area">
</div>
</div>

<script>
// üîë URL GOOGLE APPS SCRIPT
const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbw_ifKoRTR3wxHBMzZPjUIWCTrlZWs7buRB_LMfgDt7zJMZig-SJ-hCbaymPErH85N6zA/exec';

// ** PEMBOLEH UBAH DATA **
let step = 0;
let isProcessing = false;

let userData = {
'timestamp': new Date().toLocaleString('ms-MY'),
'nama_jawi': '',
'nama_rumi': '',
'ic_baru': '',
'ic_lama': '(Tiada)',
'tarikh_lahir': '',
'ic_url': '', 
'jantina': '',
'bangsa': 'Melayu',
'alamat': '',
'poskod': '',
'bandar': '',
'tel_rumah': '(Tiada)',
'tel_bimbit': '',
'email': '(Tiada)',
'kelulusan': '',
'kelulusan_lain_teks': '',
'bidang_pengajian': '(Tiada)', // <<< INI YANG KITA NAK ISI
'pekerjaan': '',
'bidang_pekerjaan': '',
'bayaran': [],
'pengakuan': '',
'disahkan': '',
'tarikh_hari_ini': new Date().toISOString().split('T')[0]
};

let tempBayaran = [];

const chatBox = document.getElementById('chat-box');
const inputArea = document.getElementById('input-area');

// ** FUNGSI BANTUAN **

function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.id = 'temp-typing-bubble';
    typingDiv.classList.add('typing-bubble');
    typingDiv.innerHTML = `
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    `;
    chatBox.appendChild(typingDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function hideTypingIndicator() {
    const typingDiv = document.getElementById('temp-typing-bubble');
    if (typingDiv) {
        typingDiv.remove();
    }
}

function addMessage(text, typeOrClass, delay = 500) {
return new Promise(resolve => {
setTimeout(() => {
const formattedText = text
.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
.replace(/\n/g, '<br>');
const msgDiv = document.createElement('div');

if (typeOrClass === 'bot-message' || typeOrClass === 'user-message') {
    msgDiv.classList.add('message');
}
msgDiv.classList.add(typeOrClass); 

msgDiv.innerHTML = formattedText;
chatBox.appendChild(msgDiv);
chatBox.scrollTop = chatBox.scrollHeight;
resolve();
}, delay);
});
}

// ** FUNGSI INTEGRASI **

async function sendDataToSheet() {
console.log("Menghantar data ke Apps Script:", userData);
const fd = new FormData();

for (const key in userData) {
    if (key === 'bayaran') {
        // Diuruskan selepas loop
    } else if (key === 'tel_bimbit' || key === 'ic_baru' || key === 'ic_lama') {
        fd.append(key, "'" + userData[key]); // Format Teks
    } else {
        fd.append(key, userData[key]);
    }
}

const bayaranString = userData.bayaran.join(', ');
fd.append('bayaran[]', bayaranString);

try {
const response = await fetch(GOOGLE_SHEET_URL, {
method: 'POST',
body: fd
});

if (response.ok) {
const result = await response.text();
console.log("Penghantaran berjaya. Respons pelayan:", result);
return true; // Berjaya
} else {
const errorText = await response.text();
throw new Error(errorText || 'HTTP error ' + response.status);
}
} catch (error) {
console.error("Gagal menghantar data ke Google Sheet:", error);
alert("‚ö†Ô∏è Ralat: Gagal merekod data ke sheet. Sila semak sambungan internet anda atau konsol (F12).");
return false; // Gagal
}
}


// ** FUNGSI UTAMA CHATBOT **

async function runChatFlow() {
if (isProcessing) return;
isProcessing = true;
inputArea.innerHTML = '';

if (step > 0) {
showTypingIndicator();
await new Promise(r => setTimeout(r, 1200));
hideTypingIndicator();
}

switch (step) {
case 0:
await addMessage('Assalamualaikum! Selamat datang ke borang pendaftaran ahli versi chatbot.', 'bot-message');
await addMessage('Saya akan bantu anda isi borang ini satu per satu.', 'bot-message');
await addMessage('**Bahagian A: Butir Diri**\n\n1. Sila masukkan **Nama Penuh (Tulisan Jawi)**.', 'bot-message');
await addMessage('Guna pautan ini untuk tukar Rumi ke Jawi:\n<a href="https://ejawimakmur.my/" target="_blank" rel="noopener noreferrer">‚û°Ô∏è Klik Sini: eJawiMakmur.my</a>', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="nama_jawi_input" placeholder="Nama Jawi..." class="form-input">
<button onclick="submitText('nama_jawi', 'nama_jawi_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('nama_jawi_input').focus();
break;

case 1:
await addMessage('2. Sila masukkan **Nama Penuh (Tulisan Rumi)** anda (mengikut Kad Pengenalan).', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="nama_rumi_input" placeholder="Nama Penuh Rumi..." class="form-input">
<button onclick="submitText('nama_rumi', 'nama_rumi_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('nama_rumi_input').focus();
break;

case 2:
await addMessage('3. Sila masukkan **No. Kad Pengenalan Baru** anda (cth: 900101-11-5555).', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="ic_baru_input" placeholder="No. KP Baru..." class="form-input">
<button onclick="submitText('ic_baru', 'ic_baru_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('ic_baru_input').focus();
break;

case 3:
await addMessage('4. **Tarikh Lahir** anda.', 'bot-message');
inputArea.innerHTML = `
<input type="date" id="tarikh_lahir_input" class="form-input" style="padding: 6px 10px;">
<button onclick="submitText('tarikh_lahir', 'tarikh_lahir_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('tarikh_lahir_input').focus();
break;

case 4:
await addMessage('5. **Jantina** anda.', 'bot-message');
inputArea.innerHTML = `
<button class="choice-button" onclick="submitChoice('jantina', 'Lelaki')">Lelaki</button>
<button class="choice-button" onclick="submitChoice('jantina', 'Perempuan')">Perempuan</button>
`;
break;

case 5:
await addMessage('6. Sila dapatkan **Pautan Gambar IC** anda.', 'bot-message');
await addMessage('Sila guna aplikasi pengimbas IC di bawah untuk ambil gambar & dapatkan URL:\n\n<a href="https://kamarul95-cloud.github.io/scanner-no-kp-v2/" target="_blank" rel="noopener noreferrer" style="font-size: 1.1em; font-weight:bold;">üì∏ Klik Sini: Pengimbas IC & Upload (V2)</a>', 'bot-message');
await addMessage('Selepas dapat URL, sila **tampal (paste)** pautan itu di ruangan bawah.', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="ic_url_input" placeholder="Tampal URL dari pengimbas di sini..." class="form-input">
<button onclick="submitText('ic_url', 'ic_url_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('ic_url_input').focus();
break;

case 6:
await addMessage('7. Sila masukkan **Alamat Surat Menyurat** penuh anda.', 'bot-message');
inputArea.innerHTML = `
<textarea id="alamat_input" placeholder="Alamat penuh..." rows="2"></textarea>
<button onclick="submitText('alamat', 'alamat_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('alamat_input').focus();
break;

case 7:
await addMessage('8. **Poskod**.', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="poskod_input" placeholder="Poskod..." class="form-input">
<button onclick="submitText('poskod', 'poskod_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('poskod_input').focus();
break;

case 8:
await addMessage('9. **Bandar**.', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="bandar_input" placeholder="Bandar..." class="form-input">
<button onclick="submitText('bandar', 'bandar_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('bandar_input').focus();
break;

case 9:
await addMessage('10. **No. Telefon Bimbit** (WhatsApp).', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="tel_bimbit_input" placeholder="01x-xxxxxxx" class="form-input">
<button onclick="submitText('tel_bimbit', 'tel_bimbit_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('tel_bimbit_input').focus();
break;

case 10:
// === INJECT DEBUG FIX: LOGIK 'KELULUSAN' ===
await addMessage('11. **Kelulusan** tertinggi.', 'bot-message');
inputArea.innerHTML = `
<button class="choice-button" onclick="submitKelulusanUniversiti()">Universiti / Kolej</button>
<button class="choice-button" onclick="handleKelulusanLain()">Lain-lain (Nyatakan)</button>
`;
break;

case 11: // STEP BARU
await addMessage('Sila nyatakan **Bidang Pengajian** anda (cth: Kejuruteraan Awam, Perakaunan).', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="bidang_pengajian_input" placeholder="Bidang Pengajian..." class="form-input">
<button onclick="submitBidangPengajian()" class="send-button-wa">‚û§</button>
`;
document.getElementById('bidang_pengajian_input').focus();
break;

case 12: // (Dulu 11)
await addMessage('Sila nyatakan kelulusan lain-lain anda (cth: SPM, STPM, Diploma).', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="kelulusan_lain_input" placeholder="Nyatakan kelulusan..." class="form-input">
<button onclick="submitKelulusanLain()" class="send-button-wa">‚û§</button>
`;
document.getElementById('kelulusan_lain_input').focus();
break;
// === AKHIR FIX ===

case 13: // (Dulu 12)
await addMessage('12. **Pekerjaan**.', 'bot-message');
inputArea.innerHTML = `
<button class="choice-button" onclick="submitChoice('pekerjaan', 'Kerajaan')">Kerajaan</button>
<button class="choice-button" onclick="submitChoice('pekerjaan', 'Swasta')">Swasta</button>
<button class="choice-button" onclick="submitChoice('pekerjaan', 'Sendiri')">Bekerja Sendiri</button>
<button class="choice-button" onclick="submitChoice('pekerjaan', 'Lain-lain')">Lain-lain (Pelajar/Suri Rumah dsb)</button>
`;
break;

case 14: // (Dulu 13)
await addMessage('13. Sila nyatakan **Bidang Pekerjaan** anda.', 'bot-message');
await addMessage('(Contoh: Guru, Jurutera IT, Peniaga, Pelajar)', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="bidang_pekerjaan_input" placeholder="Bidang pekerjaan..." class="form-input">
<button onclick="submitText('bidang_pekerjaan', 'bidang_pekerjaan_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('bidang_pekerjaan_input').focus();
break;

case 15: // (Dulu 14)
await addMessage('**Bahagian B: Bayaran**\n\nSila pilih jenis bayaran. Anda boleh pilih lebih dari satu.', 'bot-message');
await addMessage('1. Pendaftaran: RM 2.00 (Wajib)\n2. Yuran: Tahunan (RM 3.00) ATAU Sekaligus (RM 100.00)\n3. Kad Ahli: RM 5.00 (Pilihan)', 'bot-message');
tempBayaran = [];
inputArea.innerHTML = `
<button id="btn_bayar_daftar" class="choice-button" onclick="toggleBayaran('Pendaftaran: RM 2.00', 'btn_bayar_daftar')">1. Pendaftaran (RM 2.00)</button>
<button id="btn_bayar_tahunan" class="choice-button" onclick="toggleBayaran('Yuran Tahunan: RM 3.00', 'btn_bayar_tahunan', 'bayar_yuran')">2. Yuran Tahunan (RM 3.00)</button>
<button id="btn_bayar_sekaligus" class="choice-button" onclick="toggleBayaran('Sekaligus: RM 100.00', 'btn_bayar_sekaligus', 'bayar_yuran')">2. Yuran Sekaligus (RM 100.00)</button>
<button id="btn_bayar_kad" class="choice-button" onclick="toggleBayaran('Kad Ahli: RM 5.00', 'btn_bayar_kad')">3. Kad Ahli (RM 5.00)</button>
<button onclick="submitBayaran()" style="width: 100%; margin-top: 10px;">Sahkan Pilihan Bayaran</button>
`;
break;

case 16: // (Dulu 15)
await addMessage('**Bahagian C: Pengakuan Pemohon**\n\nSila baca dan setuju dengan pernyataan di bawah:', 'bot-message');
await addMessage('*"Saya mengaku kebenaran dasar PAS dan akan berusaha melaksanakan segala tuntutannya. Saya menerima PERLEMBAGAAN PAS sebagai panduan dan mengaku akan taat dan patuh kepada kepimpinan parti serta akan patuh dalam melaksanakan arahan-arahan dan keputusan-keputusan parti dari masa ke semasa."*', 'bot-message');
inputArea.innerHTML = `
<button class="choice-button" onclick="submitChoice('pengakuan', 'Saya setuju')">Saya Bersetuju</button>
<button class="choice-button red" onclick="submitChoice('pengakuan', 'Tidak setuju')">Saya Tidak Bersetuju</button>
`;
break;

case 17: // (Dulu 16)
await addMessage('14. Sila dapatkan **Pautan Tandatangan Digital** anda.', 'bot-message');
await addMessage('Sila guna aplikasi di bawah untuk tanda tangan & dapatkan URL:\n\n<a href="https://tanda-tangan-by-kamarul.netlify.app/" target="_blank" rel="noopener noreferrer" style="font-size: 1.1em; font-weight:bold;">‚úçÔ∏è Klik Sini: Pad Tandatangan Digital</a>', 'bot-message');
await addMessage('Selepas dapat URL, sila **tampal (paste)** pautan itu di ruangan bawah.', 'bot-message');
inputArea.innerHTML = `
<input type="text" id="disahkan_input" placeholder="Tampal URL dari pad t/tangan..." class="form-input">
<button onclick="submitText('disahkan', 'disahkan_input')" class="send-button-wa">‚û§</button>
`;
document.getElementById('disahkan_input').focus();
break;

case 18: // (Dulu 17)
await addMessage('**PENGESAHAN AKHIR**\n\nSila semak butiran anda sebelum hantar:', 'bot-message');
// === INJECT DEBUG FIX: KEMAS KINI 'SUMMARY' ===
let summary = `
**Nama Jawi**: ${userData.nama_jawi}
**Nama Rumi**: ${userData.nama_rumi}
**No. KP**: ${userData.ic_baru}
**Tarikh Lahir**: ${userData.tarikh_lahir}
**Jantina**: ${userData.jantina}
**Telefon**: ${userData.tel_bimbit}
**Alamat**: ${userData.alamat}, ${userData.poskod} ${userData.bandar}
**Kelulusan**: ${userData.kelulusan === 'Lain-lain' ? `Lain-lain (${userData.kelulusan_lain_teks})` : userData.kelulusan}
${userData.kelulusan === 'Universiti' ? `**Bidang Pengajian**: ${userData.bidang_pengajian || '(Tidak dinyatakan)'}\n` : ''}
**Pekerjaan**: ${userData.pekerjaan}
**Bidang Pekerjaan**: ${userData.bidang_pekerjaan || '(Tidak dinyatakan)'}
**Bayaran**: ${userData.bayaran.join(', ') || '(Belum dipilih)'}
**Pautan IC**: ${userData.ic_url ? `<a href="${userData.ic_url}" target="_blank">Lihat Pautan</a>` : 'Belum diisi'}
**Pautan T/T**: ${userData.disahkan ? `<a href="${userData.disahkan}" target="_blank">Lihat Pautan</a>` : 'Belum diisi'}
`;
// === AKHIR FIX ===
await addMessage(summary, 'bot-message');
await addMessage('Adakah semua maklumat ini **BETUL**?', 'bot-message');
inputArea.innerHTML = `
<button class="choice-button" onclick="confirmPendaftaran(true)">‚úÖ Ya, Betul & Hantar</button>
<button class="choice-button red" onclick="confirmPendaftaran(false)">‚ùå Tidak, Mula Semula</button>
`;
break;

case 19: // (Dulu 18)
await addMessage('‚úÖ **Borang Berjaya Diisi!**', 'bot-message');
await addMessage('Terima kasih.', 'bot-message');
await addMessage('Sila jemput ahli keluarga dan rakan-rakan bersama menjadi ahli PAS.', 'bot-message');
await addMessage('Dibina oleh Qamarul', 'credit-message', 1000); 
inputArea.innerHTML = `
<button class="choice-button" onclick="confirmPendaftaran(false)">Isi Borang Baru</button>
`;
break;
}
isProcessing = false;
}

// ** FUNGSI PENGENDALIAN INPUT **

function submitText(key, inputId) {
if (isProcessing) return;
const input = document.getElementById(inputId);
const value = input.value.trim();

if (!value) {
    alert('Sila isi ruangan ini. Ia wajib diisi.');
    input.focus();
    return;
}
if (key === 'ic_baru' && !/^[0-9]{6}-?[0-9]{2}-?[0-9]{4}$/.test(value)) {
    alert('Sila masukkan format No. KP yang betul (cth: 900101-11-5555 atau 900101115555)');
    input.focus();
    return;
}
if (key === 'tel_bimbit' && !/^[0-9\s-]{7,15}$/.test(value)) {
    alert('Sila masukkan nombor telefon yang sah.');
    input.focus();
    return;
}
if ((key === 'ic_url' || key === 'disahkan') && !(value.startsWith('http://') || value.startsWith('https://'))) {
    alert('Sila tampal pautan (URL) yang sah bermula dengan http:// atau https://');
    input.focus();
    return;
}

let
 cleanedValue = value;
if (key === 'ic_baru') {
    cleanedValue = value.replace(/-/g, '');
    if (cleanedValue.length === 12) {
        cleanedValue = `${cleanedValue.substr(0, 6)}-${cleanedValue.substr(6, 2)}-${cleanedValue.substr(8, 4)}`;
    }
}

userData[key] = cleanedValue;
addMessage(cleanedValue, 'user-message', 10);
step++;
runChatFlow();
}

function submitChoice(key, value) {
if (isProcessing) return;

userData[key] = value;
addMessage(value, 'user-message', 10);

if (key === 'pengakuan' && value === 'Tidak setuju') {
addMessage('Anda mesti bersetuju dengan pengakuan untuk meneruskan pendaftaran.', 'bot-message').then(() => {
step = 0;
resetUserData();
runChatFlow();
});
return;
}

step++;
runChatFlow();
}

// === INJECT DEBUG FIX: FUNGSI 'KELULUSAN' BARU ===
function submitKelulusanUniversiti() {
    if (isProcessing) return;
    addMessage('Universiti / Kolej', 'user-message', 10);
    userData['kelulusan'] = 'Universiti';
    step = 11; // Lompat ke step BARU (Bidang Pengajian)
    runChatFlow();
}

function handleKelulusanLain() {
if (isProcessing) return;
addMessage('Lain-lain (Nyatakan)', 'user-message', 10);
userData['kelulusan'] = 'Lain-lain';
step = 12; // Lompat ke step 12 (input kelulusan lain)
runChatFlow();
}

function submitKelulusanLain() {
if (isProcessing) return;
const input = document.getElementById('kelulusan_lain_input');
const value = input.value.trim();
if (!value) { alert('Sila nyatakan kelulusan anda.'); input.focus(); return; }

userData['kelulusan_lain_teks'] = value;
addMessage(value, 'user-message', 10);
step = 13; // Lompat ke step 13 (pekerjaan)
runChatFlow();
}

function submitBidangPengajian() {
    if (isProcessing) return;
    const input = document.getElementById('bidang_pengajian_input');
    const value = input.value.trim();
    if (!value) { alert('Sila nyatakan bidang pengajian anda.'); input.focus(); return; }

    userData['bidang_pengajian'] = value;
    addMessage(value, 'user-message', 10);
    step = 13; // Lompat ke 'Pekerjaan' (step 13)
    runChatFlow();
}
// === AKHIR FIX ===

// Fungsi Bahagian B (Bayaran)
function toggleBayaran(value, buttonId, group = null) {
    const btn = document.getElementById(buttonId);
    if (!btn) return; 
    
    const index = tempBayaran.indexOf(value);

    if (group === 'bayar_yuran') {
        const lainValue = value.includes('Tahunan') ? 'Sekaligus: RM 100.00' : 'Yuran Tahunan: RM 3.00';
        const lainBtnId = value.includes('Tahunan') ? 'btn_bayar_sekaligus' : 'btn_bayar_tahunan';
        const btnLain = document.getElementById(lainBtnId);
        const indexLain = tempBayaran.indexOf(lainValue);

        if (index > -1) {
            tempBayaran.splice(index, 1);
            btn.classList.remove('selected');
        } else {
            tempBayaran.push(value);
            btn.classList.add('selected');
            if (indexLain > -1) {
                tempBayaran.splice(indexLain, 1);
                if(btnLain) btnLain.classList.remove('selected');
            }
        }
    } else {
        if (index > -1) {
            tempBayaran.splice(index, 1);
            btn.classList.remove('selected');
        } else {
            tempBayaran.push(value);
            btn.classList.add('selected');
        }
    }
}

function submitBayaran() {
if (isProcessing) return;
const adaDaftar = tempBayaran.some(v => v.includes('Pendaftaran'));
const adaYuran = tempBayaran.some(v => v.includes('Tahunan') || v.includes('Sekaligus'));

if (!adaDaftar) {
alert('Sila pilih bayaran "Pendaftaran (RM 2.00)". Ia wajib.');
return;
}
if (!adaYuran) {
alert('Sila pilih salah satu yuran (Tahunan atau Sekaligus).');
return;
}

userData['bayaran'] = tempBayaran;
addMessage(`Bayaran: ${tempBayaran.join(', ')}`, 'user-message', 10);
step++;
runChatFlow();
}


// --- Fungsi Pengesahan Akhir ---
async function confirmPendaftaran(isConfirmed) {
if (isProcessing) return;
isProcessing = true;

if (isConfirmed) {
addMessage('‚úÖ Ya, Betul & Hantar', 'user-message', 10);
showTypingIndicator();
const success = await sendDataToSheet();
hideTypingIndicator();

if (success) {
step = 19; // (Dulu 18)
isProcessing = false;
runChatFlow();
} else {
addMessage('Maaf, penghantaran gagal. Sila cuba lagi.', 'bot-message');
isProcessing = false;
}

} else {
// Mula semula
addMessage('‚ùå Tidak, Mula Semula', 'user-message', 10);
resetUserData();
step = 0;
await addMessage('Baik, kita mulakan semula dari awal.', 'bot-message', 500);
isProcessing = false;
runChatFlow();
}
}

// Fungsi untuk reset data
function resetUserData() {
const timestamp = new Date().toLocaleString('ms-MY');
const tarikh_hari_ini = new Date().toISOString().split('T')[0];
    
userData = {
'timestamp': timestamp,
'nama_jawi': '',
'nama_rumi': '',
'ic_baru': '',
'ic_lama': '(Tiada)',
'tarikh_lahir': '',
'ic_url': '',
'jantina': '',
'bangsa': 'Melayu',
'alamat': '',
'poskod': '',
'bandar': '',
'tel_rumah': '(Tiada)',
'tel_bimbit': '',
'email': '(Tiada)',
'kelulusan': '',
'kelulusan_lain_teks': '',
'bidang_pengajian': '(Tiada)', // <<< Pastikan ini di-reset
'pekerjaan': '',
'bidang_pekerjaan': '',
'bayaran': [],
'pengakuan': '',
'disahkan': '',
'tarikh_hari_ini': tarikh_hari_ini
};
tempBayaran = [];
}

// ** INICIALISASI **
window.onload = function() {
runChatFlow();
};
</script>

</body>
</html>
